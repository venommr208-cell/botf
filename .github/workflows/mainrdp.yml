name: Setup UltraVNC Server
on:
  workflow_dispatch:

jobs:
  setup-vnc:
    runs-on: windows-latest
    steps:
      - name: Install & Connect Tailscale
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-runner-${{ github.run_id }}
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          "TAILSCALE_IP=$tsIP" | Out-File -Append $env:GITHUB_ENV

      - name: Install UltraVNC
        run: |
          choco install ultravnc -y

      - name: Configure UltraVNC
        shell: powershell
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          if (!(Test-Path $vncPath)) { $vncPath = "C:\Program Files\UltraVNC" }
          if (!(Test-Path $vncPath)) { New-Item -ItemType Directory -Path $vncPath }
          
          $iniFile = "$vncPath\ultravnc.ini"
          $url = "https://gitlab.com/MR.English2008/avica/-/raw/main/ultravnc.ini"
          
          if (Test-Path $iniFile) { Remove-Item -Path $iniFile -Force }
          Invoke-WebRequest -Uri $url -OutFile $iniFile

      - name: Start VNC Service
        shell: powershell
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          if (!(Test-Path "$vncPath\winvnc.exe")) { $vncPath = "C:\Program Files\UltraVNC" }
          
          cd $vncPath
          ./winvnc.exe -install
          Start-Sleep -Seconds 5
          
          Stop-Service -Name "uvnc_service" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          Start-Service -Name "uvnc_service"
          Write-Host "VNC Service is now running."

      - name: Firewall
        shell: powershell
        run: |
          if (!(Get-NetFirewallRule -DisplayName "UltraVNC_Automated" -ErrorAction SilentlyContinue)) {
              New-NetFirewallRule -DisplayName "UltraVNC_Automated" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 5900
          }

      - name: Keep Alive
        shell: powershell
        run: |
          Write-Host "Thanks to MR.English2008 for this perfect work" 
          Write-Host "follow for more in my telegram channel" 
          Write-Host "https://t.me/ME2008_RDP" 
          Write-Host "======================="
          Write-Host "CONNECTION DETAILS:"
          Write-Host "VNC IP: $($env:TAILSCALE_IP):5900"
          Write-Host "Password: MR.English2008"
          Write-Host "======================="
        
          $endTime = (Get-Date).AddHours(6)
          while ((Get-Date) -lt $endTime) {
              Write-Host "I'm still online | Made by MR.English2008 | $(Get-Date)"
              Start-Sleep -Seconds 60
          }
