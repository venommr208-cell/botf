name: Setup AnyDesk on Windows 11
on:
  workflow_dispatch:

jobs:
  setup-anydesk:
    runs-on: windows-latest
    steps:
      - name: Download AnyDesk
        shell: powershell
        run: |
          $url = "https://download.anydesk.com/AnyDesk.exe"
          $path = "$env:TEMP\AnyDesk.exe"
          Invoke-WebRequest -Uri $url -OutFile $path

      - name: Install AnyDesk
        shell: powershell
        run: |
          Start-Process -FilePath "$env:TEMP\AnyDesk.exe" -ArgumentList "--install C:\AnyDesk --start-with-win --silent" -Wait

      - name: Set AnyDesk Password
        shell: powershell
        run: |
          $password = "123456"
          $configPath = "$env:APPDATA\AnyDesk\service.conf"
          if (!(Test-Path $configPath)) {
            New-Item -ItemType File -Path $configPath -Force
          }
          Set-Content -Path $configPath -Value "ad.security.password=$password"

      - name: Start AnyDesk Service
        shell: powershell
        run: |
          Start-Service -Name AnyDesk
          Write-Host "AnyDesk service started."

      - name: Firewall Rule
        shell: powershell
        run: |
          if (!(Get-NetFirewallRule -DisplayName "AnyDesk_Automated" -ErrorAction SilentlyContinue)) {
            New-NetFirewallRule -DisplayName "AnyDesk_Automated" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 7070
          }

      - name: Keep Alive
        shell: powershell
        run: |
          Write-Host "AnyDesk is running"
          Write-Host "Password: 123456"
          $endTime = (Get-Date).AddHours(12)
          while ((Get-Date) -lt $endTime) {
              Write-Host "Still alive - $(Get-Date)"
              Start-Sleep -Seconds 60
          }
